@page "/"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using CopilotConnectorGui.Services
@using CopilotConnectorGui.Models
@using CopilotConnectorGui.Components
@using System.Security.Claims
@using Microsoft.AspNetCore.Components
@implements IDisposable
@attribute [Authorize]
@inject AppRegistrationService AppRegistrationService
@inject SchemaService SchemaService
@inject GraphService GraphService
@inject JsonFieldParserService JsonFieldParserService
@inject SemanticLabelMappingService SemanticLabelMappingService
@inject ContainerManagementService ContainerService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime

<PageTitle>Copilot Connector Setup</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Microsoft Graph Copilot Connector Setup</h1>
            
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="alert alert-danger" role="alert">
                    <strong>Error:</strong> @_errorMessage
                </div>
                
                @* ClientSecretCredential Authentication Failed Alert *@
                @if (_errorMessage.Contains("ClientSecretCredential authentication failed"))
                {
                    <div class="alert alert-warning" role="alert">
                        <h5><i class="bi bi-exclamation-triangle"></i> Authentication Issue Detected</h5>
                        <p><strong>The newly created app registration needs admin consent or has a timing issue.</strong></p>
                        
                        @if (_appRegistrationResult != null)
                        {
                            <div class="d-flex gap-2 mt-3 mb-3">
                                <button class="btn btn-primary" @onclick="() => OpenAdminConsentUrl(_appRegistrationResult.ApplicationId, _appRegistrationResult.TenantId)">
                                    <i class="bi bi-shield-check"></i> Grant Admin Consent Now
                                </button>
                                <button class="btn btn-outline-secondary" @onclick="RetrySchemaCreation">
                                    <i class="bi bi-arrow-clockwise"></i> 
                                    @{
                                        bool schemaExistsButContainerFailed = (_schemaResult != null && _schemaResult.Success && !string.IsNullOrEmpty(_schemaResult.ConnectionId)) ||
                                                                             (!string.IsNullOrEmpty(_errorMessage) && _errorMessage.Contains("Schema created but ingestion service deployment failed"));
                                    }
                                    @if (schemaExistsButContainerFailed)
                                    {
                                        <span>Retry Container Deployment</span>
                                    }
                                    else
                                    {
                                        <span>Retry Connection Creation</span>
                                    }
                                </button>
                            </div>
                        }
                        
                        <div class="alert alert-info mt-2" role="alert">
                            <h6><i class="bi bi-lightbulb"></i> What to do:</h6>
                            <ol class="mb-0">
                                <li><strong>Grant Admin Consent:</strong> Click the "Grant Admin Consent Now" button above</li>
                                <li><strong>Wait:</strong> Allow 2-3 minutes for the permissions to propagate</li>
                                <li><strong>Retry:</strong> Click the retry button to attempt the 
                                    @{
                                        bool schemaExistsForInstructions = (_schemaResult != null && _schemaResult.Success && !string.IsNullOrEmpty(_schemaResult.ConnectionId)) ||
                                                                           (!string.IsNullOrEmpty(_errorMessage) && _errorMessage.Contains("Schema created but ingestion service deployment failed"));
                                    }
                                    @if (schemaExistsForInstructions)
                                    {
                                        <span>container deployment</span>
                                    }
                                    else
                                    {
                                        <span>connection creation process</span>
                                    }
                                     again</li>
                            </ol>
                        </div>
                    </div>
                }
                
                @if (_errorMessage.Contains("TO FIX THIS:"))
                {
                    <div class="alert alert-warning" role="alert">
                        <h5><i class="bi bi-tools"></i> Quick Fix - Configure App Permissions</h5>
                        <p><strong>Follow these steps to configure the current app registration:</strong></p>
                        
                        <ol>
                            <li>Open Azure Portal: <a href="https://portal.azure.com" target="_blank" class="btn btn-sm btn-outline-primary">Open Azure Portal</a></li>
                            <li>Navigate to: <strong>Azure Active Directory</strong> ‚Üí <strong>App registrations</strong></li>
                            <li>Find app with ID: <code>3e847995-c69c-4dc4-9246-21ad3fa3d76c</code></li>
                            <li>Click <strong>"API permissions"</strong> ‚Üí <strong>"Add a permission"</strong></li>
                            <li>Select <strong>"Microsoft Graph"</strong> ‚Üí <strong>"Delegated permissions"</strong></li>
                            <li>Search for and add:
                                <ul>
                                    <li><code>Application.ReadWrite.All</code></li>
                                    <li><code>Directory.ReadWrite.All</code></li>
                                    <li><code>ExternalConnection.ReadWrite.All</code></li>
                                    <li><code>ExternalItem.ReadWrite.All</code></li>
                                </ul>
                            </li>
                            <li>Click the <strong>"Grant admin consent"</strong> button</li>
                            <li>Refresh this page and try again</li>
                        </ol>
                        
                        <div class="mt-3">
                            <a href="https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/ApplicationMenuBlade/~/CallAnAPI/appId/3e847995-c69c-4dc4-9246-21ad3fa3d76c" 
                               target="_blank" 
                               class="btn btn-primary">
                                <i class="bi bi-box-arrow-up-right"></i> Configure Permissions in Azure Portal
                            </a>
                        </div>
                    </div>
                }

                @* Incremental Consent Alert - New functionality *@
                @if (_errorMessage.Contains("Insufficient permissions") || _errorMessage.Contains("MsalUiRequiredException"))
                {
                    <div class="alert alert-info" role="alert">
                        <h5><i class="bi bi-info-circle"></i> Incremental Consent Required</h5>
                        <p><strong>We've recently added External Connection permissions to this application.</strong></p>
                        <p>Since you're already signed in, you need to provide incremental consent for the new permissions:</p>
                        
                        <div class="d-flex gap-2 mt-3">
                            <a href="MicrosoftIdentity/Account/SignOut" class="btn btn-warning">
                                <i class="bi bi-box-arrow-right"></i> Sign Out & Sign In Again
                            </a>
                            <span class="text-muted align-self-center">This will trigger consent for the new External Connection permissions</span>
                        </div>
                    </div>
                }
                else if (_errorMessage.Contains("Insufficient privileges") || _errorMessage.Contains("Application Developer"))
                {
                    <div class="alert alert-info" role="alert">
                        <h5><i class="bi bi-info-circle"></i> Permission Requirements</h5>
                        <p><strong>To create app registrations, you need one of these Azure AD roles:</strong></p>
                        <ul>
                            <li><strong>Application Developer</strong> - Can create and manage applications</li>
                            <li><strong>Cloud Application Administrator</strong> - Full application management</li>
                            <li><strong>Global Administrator</strong> - All permissions</li>
                        </ul>
                        
                        <hr>
                        
                        <h6><i class="bi bi-gear"></i> Solutions:</h6>
                        <ol>
                            <li><strong>Contact your Azure AD Administrator</strong> to assign you one of the required roles</li>
                            <li><strong>Use Azure CLI Bootstrap</strong> if you have sufficient permissions via Azure CLI:
                                <ul>
                                    <li>Install Azure CLI if not already installed</li>
                                    <li>Run <code>az login</code> in a terminal</li>
                                    <li>Click the "üöÄ Auto-Setup with Azure CLI" button above</li>
                                </ul>
                            </li>
                            <li><strong>Ask an administrator</strong> to create the app registration manually and provide you with the Application ID and Client Secret</li>
                        </ol>
                        
                        <div class="alert alert-warning mt-2" role="alert">
                            <small><strong>Note:</strong> These permissions are required because this application needs to create app registrations with Microsoft Graph API permissions for Copilot connectors.</small>
                        </div>
                    </div>
                }
            }

            @if (!string.IsNullOrEmpty(_successMessage))
            {
                <div class="alert alert-success" role="alert">
                    <strong>Success:</strong> @_successMessage
                </div>
            }

            @* Show processing UI even if authentication is temporarily lost *@
            @if (_forceShowUI && _isProcessing)
            {
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3>Processing External Connection Setup</h3>
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <small class="text-muted">Active</small>
                        </div>
                    </div>
                    <div class="card-body">
                        @* Current Status Alert *@
                        <div class="alert alert-info d-flex align-items-center">
                            <div class="flex-grow-1">
                                <strong>Current Status:</strong><br />
                                @if (!string.IsNullOrEmpty(_statusMessage))
                                {
                                    <div class="mt-1">
                                        <i class="bi bi-arrow-right text-primary"></i> @_statusMessage
                                    </div>
                                }
                                else
                                {
                                    <div class="mt-1">
                                        <i class="bi bi-arrow-right text-primary"></i> Creating your External Connection...
                                    </div>
                                }
                            </div>
                            <div class="ms-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Processing...</span>
                                </div>
                            </div>
                        </div>
                        
                        @* Progress Steps *@
                        <div class="mb-4">
                            <h6 class="mb-3">Setup Progress</h6>
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     style="width: @GetProgressWidth()" 
                                     aria-valuenow="@GetProgressValue()" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                </div>
                            </div>
                            <small class="text-muted">@GetProgressValue()% Complete</small>
                        </div>

                        @* Detailed Progress Steps *@
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="mb-3">Process Steps</h6>
                                <div class="list-group">
                                    <div class="list-group-item d-flex align-items-center @(_currentStep >= SetupStep.Configuration ? "list-group-item-success" : "")">
                                        <div class="me-3">
                                            @if (_currentStep > SetupStep.Configuration)
                                            {
                                                <i class="bi bi-check-circle-fill text-success" style="font-size: 1.2rem;"></i>
                                            }
                                            else
                                            {
                                                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                            }
                                        </div>
                                        <div class="flex-grow-1">
                                            <strong>1. Configuration Validation</strong>
                                            <div class="text-muted small">Validating tenant settings and JSON schema</div>
                                        </div>
                                        @if (_currentStep > SetupStep.Configuration)
                                        {
                                            <span class="badge bg-success">Complete</span>
                                        }
                                        else if (_currentStep == SetupStep.Configuration)
                                        {
                                            <span class="badge bg-primary">In Progress</span>
                                        }
                                    </div>
                                    
                                    <div class="list-group-item d-flex align-items-center @(_currentStep >= SetupStep.AppRegistrationCreated ? "list-group-item-success" : "")">
                                        <div class="me-3">
                                            @if (_currentStep > SetupStep.AppRegistrationCreated)
                                            {
                                                <i class="bi bi-check-circle-fill text-success" style="font-size: 1.2rem;"></i>
                                            }
                                            else if (_currentStep == SetupStep.AppRegistrationCreated)
                                            {
                                                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                            }
                                            else
                                            {
                                                <i class="bi bi-circle text-muted" style="font-size: 1.2rem;"></i>
                                            }
                                        </div>
                                        <div class="flex-grow-1">
                                            <strong>2. App Registration Creation</strong>
                                            <div class="text-muted small">Creating Azure AD application with required permissions</div>
                                        </div>
                                        @if (_currentStep > SetupStep.AppRegistrationCreated)
                                        {
                                            <span class="badge bg-success">Complete</span>
                                        }
                                        else if (_currentStep == SetupStep.AppRegistrationCreated)
                                        {
                                            <span class="badge bg-primary">In Progress</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Pending</span>
                                        }
                                    </div>
                                    
                                    <div class="list-group-item d-flex align-items-center @(_currentStep >= SetupStep.AdminConsentRequired ? "list-group-item-warning" : "")">
                                        <div class="me-3">
                                            @if (_currentStep > SetupStep.AdminConsentRequired)
                                            {
                                                <i class="bi bi-check-circle-fill text-success" style="font-size: 1.2rem;"></i>
                                            }
                                            else if (_currentStep == SetupStep.AdminConsentRequired)
                                            {
                                                <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 1.2rem;"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-circle text-muted" style="font-size: 1.2rem;"></i>
                                            }
                                        </div>
                                        <div class="flex-grow-1">
                                            <strong>3. Permission Consent</strong>
                                            <div class="text-muted small">Administrator consent for External Connection permissions</div>
                                        </div>
                                        @if (_currentStep > SetupStep.AdminConsentRequired)
                                        {
                                            <span class="badge bg-success">Complete</span>
                                        }
                                        else if (_currentStep == SetupStep.AdminConsentRequired)
                                        {
                                            <span class="badge bg-warning">Action Required</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Pending</span>
                                        }
                                    </div>
                                    
                                    <div class="list-group-item d-flex align-items-center @(_currentStep == SetupStep.Completed ? "list-group-item-success" : "")">
                                        <div class="me-3">
                                            @if (_currentStep == SetupStep.Completed)
                                            {
                                                <i class="bi bi-check-circle-fill text-success" style="font-size: 1.2rem;"></i>
                                            }
                                            else if (_currentStep == SetupStep.CreatingConnection)
                                            {
                                                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                            }
                                            else if (_currentStep > SetupStep.AdminConsentRequired)
                                            {
                                                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                            }
                                            else
                                            {
                                                <i class="bi bi-circle text-muted" style="font-size: 1.2rem;"></i>
                                            }
                                        </div>
                                        <div class="flex-grow-1">
                                            <strong>4. Connection & Schema Creation</strong>
                                            <div class="text-muted small">Creating External Connection and defining data schema</div>
                                        </div>
                                        @if (_currentStep == SetupStep.Completed)
                                        {
                                            <span class="badge bg-success">Complete</span>
                                        }
                                        else if (_currentStep == SetupStep.CreatingConnection)
                                        {
                                            <span class="badge bg-primary">In Progress</span>
                                        }
                                        else if (_currentStep > SetupStep.AdminConsentRequired)
                                        {
                                            <span class="badge bg-primary">In Progress</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Pending</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        @* Real-time Activity Log *@
                        <div class="mb-3">
                            <h6 class="mb-2">Activity Log</h6>
                            <div class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">
                                @foreach (var logEntry in _activityLog.TakeLast(10))
                                {
                                    <div class="d-flex align-items-start mb-2">
                                        <small class="text-muted me-2" style="min-width: 60px;">@logEntry.Timestamp.ToString("HH:mm:ss")</small>
                                        <div class="me-2">
                                            @if (logEntry.Type == ActivityLogType.Success)
                                            {
                                                <i class="bi bi-check-circle-fill text-success"></i>
                                            }
                                            else if (logEntry.Type == ActivityLogType.Warning)
                                            {
                                                <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                                            }
                                            else if (logEntry.Type == ActivityLogType.Error)
                                            {
                                                <i class="bi bi-x-circle-fill text-danger"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-info-circle-fill text-primary"></i>
                                            }
                                        </div>
                                        <small class="flex-grow-1">@logEntry.Message</small>
                                    </div>
                                }
                                @if (!_activityLog.Any())
                                {
                                    <small class="text-muted">Waiting for activity...</small>
                                }
                            </div>
                        </div>

                        @* Time and Performance Info *@
                        <div class="row text-center">
                            <div class="col-md-4">
                                <div class="border rounded p-2">
                                    <strong class="text-primary">@_elapsedTime</strong><br />
                                    <small class="text-muted">Elapsed Time</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="border rounded p-2">
                                    <strong class="text-info">@_currentRetryCount/@_maxRetries</strong><br />
                                    <small class="text-muted">Retry Attempts</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="border rounded p-2">
                                    <strong class="text-success">Active</strong><br />
                                    <small class="text-muted">Connection Status</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                This process may take several minutes. The page will update automatically.
                            </small>
                        </div>
                    </div>
                </div>
            }
            else
            {

            <AuthorizeView>
                <NotAuthorized>
                    <div class="card">
                        <div class="card-header">
                            <h3>Authentication Required</h3>
                        </div>
                        <div class="card-body text-center">
                            <div class="mb-4">
                                <i class="bi bi-shield-lock" style="font-size: 3rem; color: #0078d4;"></i>
                            </div>
                            <h4>Sign in to Your Microsoft Entra ID Tenant</h4>
                            <p class="lead">Please sign in with your Microsoft account to continue.</p>
                            
                            <div class="alert alert-primary">
                                <h6><i class="bi bi-info-circle"></i> What This Application Does</h6>
                                <p class="mb-0">This application helps you create <strong>Microsoft Copilot Connectors</strong> for Microsoft Copilot. 
                                It automatically sets up the required Azure app registrations, configures permissions, and creates the connection schema 
                                so you can integrate your external data sources with Microsoft 365 search and Copilot experiences.</p>
                            </div>
                            
                            <div class="d-grid gap-2" style="max-width: 300px; margin: 0 auto;">
                                <a href="MicrosoftIdentity/Account/SignIn" class="btn btn-primary btn-lg">
                                    <i class="bi bi-microsoft"></i> Sign in with Microsoft
                                </a>
                            </div>

                            @* Hidden buttons - keeping functionality but hiding from UI *@
                            <div style="display: none;">
                                <button type="button" class="btn btn-success btn-lg" @onclick="PerformBootstrap" disabled="@_isProcessing">
                                    @if (_isBootstrapping)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        <text>Setting up automatically...</text>
                                    }
                                    else
                                    {
                                        <i class="bi bi-magic"></i> <text>üöÄ Auto-Setup with Azure CLI</text>
                                    }
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-lg" @onclick="ManualAutoLogin" disabled="@_isProcessing">
                                    @if (_isProcessing && !_isBootstrapping)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        <text>Trying Auto Sign-in...</text>
                                    }
                                    else
                                    {
                                        <i class="bi bi-arrow-clockwise"></i> <text>Try Auto Sign-in</text>
                                    }
                                </button>
                                <button type="button" class="btn btn-info btn-lg" @onclick="OpenWebTerminal">
                                    <i class="bi bi-terminal-fill"></i> Open Azure CLI Terminal
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-lg" @onclick="CheckAzureCli">
                                    <i class="bi bi-terminal"></i> Use Azure CLI Authentication
                                </button>
                            </div>
                        </div>
                    </div>
                </NotAuthorized>
                <Authorized Context="authUser">
                    @if (_currentStep == SetupStep.Configuration)
                    {
                        <div class="card">
                            <div class="card-header">
                                <h3>Step 1: Configuration</h3>
                                @if (_useAzureCli)
                                {
                                    <small class="text-muted">Authenticated via Azure CLI</small>
                                }
                                else
                                {
                                    <small class="text-muted">Signed in as: @authUser.User.Identity?.Name</small>
                                }
                            </div>
                            <div class="card-body">
                                <EditForm Model="@_configuration" Context="editContext">
                                    <DataAnnotationsValidator />
                                    <ValidationSummary />

                                    <div class="mb-3">
                                        <label for="tenantId" class="form-label">Tenant ID</label>
                                        <InputText id="tenantId" class="form-control" @bind-Value="_configuration.TenantId" placeholder="Auto-populated from your login" readonly />
                                        <div class="form-text">
                                            <i class="bi bi-check-circle-fill text-success"></i> 
                                            Auto-populated from your authenticated session
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="connectionName" class="form-label">Connection Name</label>
                                        <InputText id="connectionName" class="form-control" @bind-Value="_configuration.ConnectionName" placeholder="Enter a name for your connector" />
                                        <ValidationMessage For="@(() => _configuration.ConnectionName)" />
                                        <div class="form-text">
                                            This will be the display name for your External Connection (3-128 characters). Must start and end with alphanumeric characters.
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="connectionDescription" class="form-label">Connection Description</label>
                                        <InputTextArea id="connectionDescription" class="form-control" rows="3" @bind-Value="_configuration.ConnectionDescription" placeholder="Describe what data this connector will index" />
                                        <ValidationMessage For="@(() => _configuration.ConnectionDescription)" />
                                        <div class="form-text">
                                            Provide a clear description of the data source and what content it represents (10-500 characters)
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="jsonSample" class="form-label">JSON Sample Data</label>
                                        <InputTextArea id="jsonSample" class="form-control" rows="10" @bind-Value="_configuration.JsonSample" placeholder="Enter sample JSON data for schema creation" />
                                        <ValidationMessage For="@(() => _configuration.JsonSample)" />
                                        <div class="form-text">Provide a sample JSON object that represents the data structure you want to index</div>
                                        
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="LoadSampleJson">
                                                Load Sample JSON
                                            </button>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="bi bi-shield-lock"></i> Access Control (ACL)
                                        </label>
                                        <div class="form-text mb-2">
                                            Select which Entra ID groups should have access to the data in this connector. If no groups are selected, all users in your tenant will have access.
                                        </div>
                                        
                                        @if (_isLoadingGroups)
                                        {
                                            <div class="text-center py-3">
                                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                    <span class="visually-hidden">Loading groups...</span>
                                                </div>
                                                <span class="ms-2">Loading Entra ID groups...</span>
                                            </div>
                                        }
                                        else if (_availableGroups == null || !_availableGroups.Any())
                                        {
                                            <div class="alert alert-warning" role="alert">
                                                <i class="bi bi-exclamation-triangle"></i> No groups found or unable to load groups.
                                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" @onclick="LoadEntraIdGroups">
                                                    <i class="bi bi-arrow-clockwise"></i> Retry
                                                </button>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                                @foreach (var group in _availableGroups)
                                                {
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" 
                                                               id="group_@group.Id" 
                                                               checked="@_configuration.AllowedGroupIds.Contains(group.Id)"
                                                               @onchange="@(e => ToggleGroupSelection(group.Id, (bool)e.Value!))" />
                                                        <label class="form-check-label" for="group_@group.Id">
                                                            <strong>@group.DisplayName</strong>
                                                            @if (!string.IsNullOrEmpty(group.Description))
                                                            {
                                                                <br />
                                                                <small class="text-muted">@group.Description</small>
                                                            }
                                                            @if (!string.IsNullOrEmpty(group.Mail))
                                                            {
                                                                <br />
                                                                <small class="text-muted"><i class="bi bi-envelope"></i> @group.Mail</small>
                                                            }
                                                        </label>
                                                    </div>
                                                }
                                            </div>
                                            <div class="form-text mt-2">
                                                <i class="bi bi-info-circle"></i> Selected @_configuration.AllowedGroupIds.Count group(s). 
                                                @if (_configuration.AllowedGroupIds.Count == 0)
                                                {
                                                    <span class="text-warning"><strong>All tenant users</strong> will have access.</span>
                                                }
                                            </div>
                                        }
                                    </div>

                                    <div class="alert alert-info" style="display: none;">
                                        <h6><i class="bi bi-info-circle"></i> Choose Your Setup Method:</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <strong>üîµ App Registration Method:</strong>
                                                <ul class="small mb-0">
                                                    <li>Creates a dedicated app registration</li>
                                                    <li>Uses application permissions</li>
                                                    <li>Requires manual admin consent</li>
                                                    <li>More secure for production</li>
                                                </ul>
                                            </div>
                                            <div class="col-md-6">
                                                <strong>üü¢ Quick Setup Method:</strong>
                                                <ul class="small mb-0">
                                                    <li>Uses existing OAuth app permissions</li>
                                                    <li>Uses delegated permissions</li>
                                                    <li>May work without additional consent</li>
                                                    <li>Faster for testing/development</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-primary" @onclick="ProceedToSchemaMapping" disabled="@_isProcessing">
                                            @if (_isProcessing)
                                            {
                                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                                <text> Processing JSON...</text>
                                            }
                                            else
                                            {
                                                <i class="fas fa-arrow-right me-2"></i>
                                                <text>Next: Configure Schema Mapping</text>
                                            }
                                        </button>
                                        
                                        @* Hidden Quick Setup button - keeping functionality *@
                                        <button type="button" class="btn btn-success" @onclick="HandleSimplifiedConfiguration" disabled="@_isProcessing" style="display: none;">
                                            @if (_isProcessing)
                                            {
                                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                                <text> Processing...</text>
                                            }
                                            else
                                            {
                                                <i class="bi bi-lightning-charge"></i>
                                                <text>Quick Setup (Use OAuth App)</text>
                                            }
                                        </button>
                                        
                                        <a href="MicrosoftIdentity/Account/SignOut" class="btn btn-outline-secondary">
                                            Sign Out
                                        </a>
                                    </div>
                                </EditForm>
                            </div>
                        </div>
                    }

                    @if (_currentStep == SetupStep.AppRegistrationCreated)
                    {
                        <div class="card">
                            <div class="card-header">
                                <h3>Step 2: App Registration Created</h3>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-success">
                                    <strong>‚úÖ App Registration Created Successfully!</strong><br />
                                    Application ID: <code>@(_appRegistrationResult?.ApplicationId ?? "Loading...")</code>
                                </div>
                                
                                <div class="alert alert-info">
                                    <strong>‚è≥ Waiting for Credential Propagation</strong><br />
                                    Azure AD needs time to propagate the new credentials. This prevents authentication errors.<br />
                                    <small class="text-muted">Waiting 30 seconds before creating the external connection...</small>
                                </div>
                                
                                <div class="d-flex justify-content-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Waiting for credential propagation...</span>
                                    </div>
                                </div>
                                
                                <div class="mt-3 text-center">
                                    <small class="text-muted">
                                        This delay helps prevent the "AADSTS7000215: Invalid client secret" error<br />
                                        that commonly occurs with newly created app registrations.
                                    </small>
                                </div>
                            </div>
                        </div>
                    }

                    @if (_currentStep == SetupStep.AdminConsentRequired && _appRegistrationResult != null)
                    {
                        <div class="card">
                            <div class="card-header">
                                <h3>Step 3: Admin Consent Required</h3>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-warning">
                                    <h5><i class="bi bi-exclamation-triangle"></i> Administrator Consent Required</h5>
                                    <p>The app registration was created successfully, but it needs administrator consent for the External Connection permissions before it can create the connection and schema.</p>
                                </div>

                                <div class="alert alert-info">
                                    <h6><i class="bi bi-info-circle"></i> What happens next:</h6>
                                    <ol class="mb-0">
                                        <li>Click "Grant Admin Consent" below</li>
                                        <li>You'll be redirected to Microsoft's consent page</li>
                                        <li>Review and approve the permissions</li>
                                        <li>Return to this page to continue the setup</li>
                                    </ol>
                                </div>

                                <div class="mb-3">
                                    <h6>App Registration Details:</h6>
                                    <p><strong>Application ID:</strong> <code>@_appRegistrationResult.ApplicationId</code></p>
                                    <p><strong>Tenant ID:</strong> <code>@_appRegistrationResult.TenantId</code></p>
                                </div>

                                <div class="mb-3">
                                    <h6>Required Permissions:</h6>
                                    <ul>
                                        <li><code>ExternalConnection.ReadWrite.OwnedBy</code> - Create and manage external connections</li>
                                        <li><code>ExternalItem.ReadWrite.OwnedBy</code> - Create and manage external items</li>
                                    </ul>
                                </div>

                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary btn-lg" @onclick="() => GrantAdminConsent(_appRegistrationResult.ApplicationId, _appRegistrationResult.TenantId)" disabled="@_isProcessing">
                                        @if (_isProcessing)
                                        {
                                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                            <text> Granting Consent...</text>
                                        }
                                        else
                                        {
                                            <i class="bi bi-shield-check"></i>
                                            <text> Grant Admin Consent</text>
                                        }
                                    </button>
                                    
                                    <button class="btn btn-success" @onclick="ContinueAfterConsent" disabled="@_isProcessing">
                                        <i class="bi bi-arrow-right"></i>
                                        Continue Setup
                                    </button>
                                </div>

                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="bi bi-lightbulb"></i>
                                        <strong>Tip:</strong> After granting consent, click "Continue Setup" to proceed with creating the External Connection and schema.
                                    </small>
                                </div>
                            </div>
                        </div>
                    }

                    @if (_currentStep == SetupStep.Completed && _appRegistrationResult != null)
                    {
                        <div class="card">
                            <div class="card-header">
                                <h3>Step 3: Setup Complete!</h3>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-success">
                                    <strong>Congratulations!</strong> Your Microsoft Graph External Connection has been created successfully.
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>App Registration Details</h5>
                                        <div class="mb-3">
                                            <label class="form-label">Application (Client) ID</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" value="@_appRegistrationResult.ApplicationId" readonly />
                                                <button class="btn btn-outline-secondary" type="button" @onclick="() => CopyToClipboard(_appRegistrationResult.ApplicationId)">
                                                    Copy
                                                </button>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Client Secret</label>
                                            <div class="input-group">
                                                <input type="@(_showSecret ? "text" : "password")" class="form-control" value="@_appRegistrationResult.ClientSecret" readonly />
                                                <button class="btn btn-outline-secondary" type="button" @onclick="() => _showSecret = !_showSecret">
                                                    @(_showSecret ? "Hide" : "Show")
                                                </button>
                                                <button class="btn btn-outline-secondary" type="button" @onclick="() => CopyToClipboard(_appRegistrationResult.ClientSecret)">
                                                    Copy
                                                </button>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Tenant ID</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" value="@_appRegistrationResult.TenantId" readonly />
                                                <button class="btn btn-outline-secondary" type="button" @onclick="() => CopyToClipboard(_appRegistrationResult.TenantId)">
                                                    Copy
                                                </button>
                                            </div>
                                        </div>

                                    </div>

                                    <div class="col-md-6">
                                        <h5>Connection Details</h5>
                                        @if (_schemaResult != null)
                                        {
                                            <div class="mb-3">
                                                <label class="form-label">Connection Name</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" value="@_configuration.ConnectionName" readonly />
                                                    <button class="btn btn-outline-secondary" type="button" @onclick="() => CopyToClipboard(_configuration.ConnectionName)">
                                                        Copy
                                                    </button>
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Connection ID</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" value="@_schemaResult.ConnectionId" readonly />
                                                    <button class="btn btn-outline-secondary" type="button" @onclick="() => CopyToClipboard(_schemaResult.ConnectionId!)">
                                                        Copy
                                                    </button>
                                                </div>
                                            </div>
                                        }

                                        <div class="alert alert-warning">
                                            <strong>Important:</strong> Save these credentials securely. The client secret cannot be retrieved again.
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <h5><i class="bi bi-rocket"></i> Next Steps</h5>
                                    <div class="alert alert-info">
                                        <h6><i class="bi bi-lightbulb"></i> Deploy Ingestion Service</h6>
                                        <p class="mb-2">Deploy a containerized ingestion service to automatically handle external item creation:</p>
                                        
                                        @if (_isDeployingContainer)
                                        {
                                            <div class="d-flex align-items-center">
                                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                                <span>Deploying ingestion service container...</span>
                                            </div>
                                        }
                                        else if (_containerDeploymentResult != null)
                                        {
                                            @if (_containerDeploymentResult.Success)
                                            {
                                                <div class="alert alert-success">
                                                    <h6><i class="bi bi-check-circle"></i> Container Deployed Successfully!</h6>
                                                    <p class="mb-2"><strong>Service URL:</strong> <a href="@_containerDeploymentResult.DeploymentResult!.ServiceUrl" target="_blank">@_containerDeploymentResult.DeploymentResult.ServiceUrl</a></p>
                                                    <p class="mb-2"><strong>API Documentation:</strong> <a href="@(_containerDeploymentResult.DeploymentResult.ServiceUrl)/swagger" target="_blank">Swagger UI</a></p>
                                                    <p class="mb-0"><strong>Container:</strong> @_containerDeploymentResult.DeploymentResult.ContainerName</p>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="alert alert-warning">
                                                    <h6><i class="bi bi-exclamation-triangle"></i> Container Deployment Failed</h6>
                                                    <p>@_containerDeploymentResult.ErrorMessage</p>
                                                    <div class="d-flex gap-2 mt-2">
                                                        <button class="btn btn-outline-primary" @onclick="DeployIngestionService" disabled="@_isDeployingContainer">
                                                            @if (_isDeployingContainer)
                                                            {
                                                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                                            }
                                                            <i class="bi bi-arrow-clockwise"></i> Retry Container Deployment
                                                        </button>
                                                    </div>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <button class="btn btn-success" @onclick="DeployIngestionService">
                                                <i class="bi bi-cloud-upload"></i> Deploy Ingestion Service
                                            </button>
                                        }
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <a href="/ingestion-services" class="btn btn-outline-primary">
                                            <i class="bi bi-hdd-stack"></i> View All Services
                                        </a>
                                        <button class="btn btn-primary" @onclick="StartOver">Create Another Connection</button>
                                        <a href="MicrosoftIdentity/Account/SignOut" class="btn btn-outline-secondary">Sign Out</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </Authorized>
            </AuthorizeView>
            }

            @* Schema Mapping Section *@
            @if ((_currentStep == SetupStep.SchemaMapping || 
                  (_isProcessing && _forceShowUI && _schemaMappingConfig != null)) && 
                 _schemaMappingConfig != null)
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Step 2: Configure Schema & Semantic Labels</h5>
                    </div>
                    <div class="card-body">
                        <SchemaMappingComponent 
                            Configuration="_schemaMappingConfig" 
                            OnSave="HandleSchemaMappingSubmit"
                            OnCancel="BackToConfiguration"
                            SemanticLabelService="SemanticLabelMappingService"
                            AllowedGroupIds="_configuration.AllowedGroupIds"
                            AvailableGroups="_availableGroups" />
                    </div>
                </div>
            }

            @* Progress indicator during schema mapping submission *@
            @if (_isProcessing && _forceShowUI && !string.IsNullOrEmpty(_statusMessage))
            {
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border text-primary me-3" role="status">
                                <span class="visually-hidden">Processing...</span>
                            </div>
                            <div>
                                <h6 class="mb-1">Creating Connection...</h6>
                                <p class="mb-0 text-muted">@_statusMessage</p>
                            </div>
                        </div>
                    </div>
                </div>
            }

            @* Azure CLI Configuration Section - shown regardless of authentication status *@
            @if (_useAzureCli && _currentStep == SetupStep.Configuration)
            {
                <div class="card mt-3">
                    <div class="card-header">
                        <h3>Step 1: Configuration (Azure CLI)</h3>
                        <small class="text-muted">Using Azure CLI authentication</small>
                    </div>
                    <div class="card-body">
                        <EditForm Model="@_configuration" Context="editContext">
                            <DataAnnotationsValidator />
                            <ValidationSummary />

                            @if (!string.IsNullOrEmpty(_errorMessage))
                            {
                                <div class="alert alert-danger">@_errorMessage</div>
                            }

                            @if (!string.IsNullOrEmpty(_successMessage))
                            {
                                <div class="alert alert-success">@_successMessage</div>
                            }

                            <div class="mb-3">
                                <label for="tenantId" class="form-label">Tenant ID</label>
                                <InputText id="tenantId" class="form-control" @bind-Value="_configuration.TenantId" placeholder="Enter your Azure AD tenant ID" />
                                <div class="form-text">
                                    Enter the tenant ID where you want to create the app registration
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="jsonSample" class="form-label">JSON Sample Data</label>
                                <InputTextArea id="jsonSample" class="form-control" rows="10" @bind-Value="_configuration.JsonSample" placeholder="Enter sample JSON data for schema creation" />
                                <div class="form-text">Provide a sample JSON object that represents the data structure you want to index</div>
                                
                                <div class="mt-2">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="LoadSampleJson">
                                        Load Sample JSON
                                    </button>
                                </div>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary" @onclick="ProceedToSchemaMapping" disabled="@_isProcessing">
                                    @if (_isProcessing)
                                    {
                                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                        <text> Processing JSON...</text>
                                    }
                                    else
                                    {
                                        <i class="fas fa-arrow-right me-2"></i>
                                        <text>Next: Configure Schema Mapping</text>
                                    }
                                </button>
                                <button type="button" class="btn btn-outline-secondary" @onclick="() => _useAzureCli = false">
                                    Back to Authentication
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            }
        </div>
    </div>

    @* @if (_showWebTerminal)
    {
        <div class="row mt-4">
            <div class="col-12">
                <WebTerminal SessionId="@_terminalSessionId" OnClose="CloseWebTerminal" />
            </div>
        </div>
    } *@
</div>

@* Activity Log Support Classes *@
@code {
    public enum ActivityLogType
    {
        Info,
        Success,
        Warning,
        Error
    }

    public class ActivityLogEntry
    {
        public DateTime Timestamp { get; set; }
        public string Message { get; set; } = string.Empty;
        public ActivityLogType Type { get; set; }
    }

    // Activity Log Support
    private List<ActivityLogEntry> _activityLog = new();
    private Timer? _uiUpdateTimer;
    private DateTime _processStartTime;
    private string _elapsedTime = "00:00";
    private int _currentRetryCount = 0;
    private int _maxRetries = 5;

    private TenantConfigurationModel _configuration = new();
    private AppRegistrationResult? _appRegistrationResult;
    private SchemaCreationResult? _schemaResult;
    private SchemaMappingConfiguration? _schemaMappingConfig;
    private bool _isProcessing = false;
    private bool _isBootstrapping = false;
    private bool _showSecret = false;
    private bool _useAzureCli = false;
    private bool _autoLoginAttempted = false;
    private string _terminalSessionId = Guid.NewGuid().ToString();
    private string _errorMessage = string.Empty;
    private string _successMessage = string.Empty;
    private string _statusMessage = string.Empty;
    private SetupStep _currentStep = SetupStep.Configuration;
    private bool _forceShowUI = false; // Force show UI during processing to prevent disappearing
    
    // Container deployment variables
    private bool _isDeployingContainer = false;
    private CompleteDeploymentResult? _containerDeploymentResult;

    // ACL / Group picker variables
    private List<EntraIdGroupInfo> _availableGroups = new();
    private bool _isLoadingGroups = false;

    [CascadingParameter]
    public Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // Try to restore state if we're coming back from admin consent
        await TryRestoreStateAfterConsent();
        
        if (AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;
            if (authState.User.Identity?.IsAuthenticated ?? false)
            {
                // Extract tenant ID from the authenticated user's claims
                var tenantIdClaim = authState.User.FindFirst("tid") ?? authState.User.FindFirst("http://schemas.microsoft.com/identity/claims/tenantid");
                if (tenantIdClaim != null && string.IsNullOrEmpty(_configuration.TenantId))
                {
                    _configuration.TenantId = tenantIdClaim.Value;
                    StateHasChanged();
                }

                // Load available Entra ID groups for ACL configuration
                await LoadEntraIdGroups();
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Check if auto-login failed (can only do this after render)
            try
            {
                var url = await JSRuntime.InvokeAsync<string>("eval", "window.location.href");
                if (url.Contains("autoLoginFailed=true"))
                {
                    if (url.Contains("reason=placeholder"))
                    {
                        _errorMessage = "SSO is not available yet: This application is configured for creating app registrations. Once you complete the setup process, SSO will be available for future sessions. Please use 'Sign in with Microsoft' to begin.";
                    }
                    else if (url.Contains("reason=configuration"))
                    {
                        _errorMessage = "Auto sign-in is not available: This application needs to be configured with a valid Azure AD app registration first. Please use 'Sign in with Microsoft' for initial setup.";
                    }
                    else
                    {
                        _errorMessage = "Auto sign-in failed. Please sign in manually or try again.";
                    }
                    StateHasChanged();
                }

                // Attempt automatic silent authentication if not already authenticated
                if (AuthenticationStateTask != null)
                {
                    var authState = await AuthenticationStateTask;
                    if (!(authState.User.Identity?.IsAuthenticated ?? false) && !_autoLoginAttempted)
                    {
                        _autoLoginAttempted = true;
                        await TryAutoLogin();
                    }
                }
            }
            catch
            {
                // Ignore JavaScript interop errors during auto-login attempts
            }
        }
    }

    private async Task TryAutoLogin()
    {
        try
        {
            // Check if we're already authenticated in this app
            if (AuthenticationStateTask != null)
            {
                var authState = await AuthenticationStateTask;
                if (authState.User.Identity?.IsAuthenticated == true)
                {
                    // Already authenticated - just refresh the page to show authenticated content
                    StateHasChanged();
                    return;
                }
            }

            // Check for Microsoft authentication cookies (from Office 365, Azure Portal, etc.)
            var hasMicrosoftSession = await JSRuntime.InvokeAsync<bool>("eval", @"
                document.cookie.indexOf('ESTSAUTH') !== -1 || 
                document.cookie.indexOf('ESTSAUTHPERSISTENT') !== -1 || 
                document.cookie.indexOf('.AspNetCore.') !== -1 ||
                document.cookie.indexOf('SignInStateCookie') !== -1
            ");
            
            if (hasMicrosoftSession)
            {
                // Attempt silent authentication to leverage existing Microsoft session
                await JSRuntime.InvokeVoidAsync("window.location.assign", "/auto-login");
            }
        }
        catch
        {
            // Silent failure - don't show error for auto-login attempts
        }
    }

    private async Task ManualAutoLogin()
    {
        try
        {
            _isProcessing = true;
            _errorMessage = string.Empty;
            StateHasChanged();

            // First check if we're already authenticated
            if (AuthenticationStateTask != null)
            {
                var authState = await AuthenticationStateTask;
                if (authState.User.Identity?.IsAuthenticated == true)
                {
                    _successMessage = "You are already signed in! Refreshing the page...";
                    StateHasChanged();
                    await Task.Delay(1000);
                    await JSRuntime.InvokeVoidAsync("window.location.reload");
                    return;
                }
            }

            // Check for any Microsoft authentication session (Office 365, Azure Portal, etc.)
            var hasMicrosoftSession = await JSRuntime.InvokeAsync<bool>("eval", @"
                document.cookie.indexOf('ESTSAUTH') !== -1 || 
                document.cookie.indexOf('ESTSAUTHPERSISTENT') !== -1 || 
                document.cookie.indexOf('.AspNetCore.') !== -1 ||
                document.cookie.indexOf('SignInStateCookie') !== -1 ||
                localStorage.getItem('msal.idtoken') !== null ||
                sessionStorage.getItem('msal.idtoken') !== null
            ");
            
            if (!hasMicrosoftSession)
            {
                _errorMessage = "No Microsoft authentication session detected. Please sign in to portal.office.com or use 'Sign in with Microsoft' below.";
                _isProcessing = false;
                StateHasChanged();
                return;
            }

            _successMessage = "Microsoft session detected. Attempting auto sign-in...";
            StateHasChanged();
            await Task.Delay(500); // Brief delay to show the message

            // Attempt silent authentication using existing Microsoft session
            await JSRuntime.InvokeVoidAsync("window.location.assign", "/auto-login");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Auto sign-in failed: {ex.Message}. Please use 'Sign in with Microsoft' instead.";
            _isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task PerformBootstrap()
    {
        try
        {
            _isBootstrapping = true;
            _isProcessing = true;
            _errorMessage = string.Empty;
            StateHasChanged();

            // Check bootstrap status first
            var statusResponse = await JSRuntime.InvokeAsync<object>("fetch", "/api/bootstrap/status");
            var statusResult = await JSRuntime.InvokeAsync<string>("response => response.json()", statusResponse);
            
            // Parse the status result (simplified - in production you'd use proper JSON parsing)
            if (statusResult.Contains("\"canBootstrap\":false"))
            {
                if (statusResult.Contains("\"azureCliInstalled\":false"))
                {
                    _errorMessage = "Azure CLI is not installed. Please install Azure CLI first: https://docs.microsoft.com/en-us/cli/azure/install-azure-cli";
                }
                else if (statusResult.Contains("\"azureCliLoggedIn\":false"))
                {
                    _errorMessage = "Please log in to Azure CLI first by running: az login";
                }
                else
                {
                    _errorMessage = "Bootstrap requirements not met. Please ensure Azure CLI is installed and you're logged in.";
                }
                return;
            }

            _successMessage = "Azure CLI detected! Creating app registration...";
            StateHasChanged();
            await Task.Delay(500);

            // Perform the bootstrap
            var response = await JSRuntime.InvokeAsync<object>("fetch", "/api/bootstrap/start", new
            {
                method = "POST",
                headers = new { ContentType = "application/json" }
            });
            
            var result = await JSRuntime.InvokeAsync<string>("response => response.json()", response);
            
            if (result.Contains("\"success\":true"))
            {
                _successMessage = "üéâ Bootstrap completed successfully! The application has been configured with a new app registration. Please restart the application to enable SSO.";
                _errorMessage = string.Empty;
                
                // Show restart instructions
                await Task.Delay(2000);
                _successMessage += "\n\n‚ö†Ô∏è IMPORTANT: Please restart the application (Ctrl+C and run 'dotnet run' again) to load the new configuration.";
            }
            else
            {
                _errorMessage = "Bootstrap failed. Please try manual setup instead.";
                _successMessage = string.Empty;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Bootstrap error: {ex.Message}. Please try manual setup instead.";
            _successMessage = string.Empty;
        }
        finally
        {
            _isBootstrapping = false;
            _isProcessing = false;
            StateHasChanged();
        }
    }

    private void OpenWebTerminal()
    {
        _terminalSessionId = Guid.NewGuid().ToString();
        // Web terminal functionality - placeholder
        StateHasChanged();
    }

    private void CloseWebTerminal()
    {
        // Web terminal functionality - placeholder
        StateHasChanged();
    }

    private async Task CheckAzureCli()
    {
        try
        {
            _isProcessing = true;
            _errorMessage = string.Empty;
            StateHasChanged();

            var isLoggedIn = await GraphService.IsAzureCliLoggedInAsync();
            if (isLoggedIn)
            {
                _useAzureCli = true;
                _currentStep = SetupStep.Configuration;
                _successMessage = "Azure CLI authentication detected. You can now proceed with app registration creation.";
            }
            else
            {
                _errorMessage = "Azure CLI authentication not found. Please run 'az login' in your terminal first, then try again.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error checking Azure CLI authentication: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task HandleConfigurationSubmit()
    {
        try
        {
            _errorMessage = string.Empty;
            
            // Validate required fields
            if (string.IsNullOrWhiteSpace(_configuration.TenantId))
            {
                _errorMessage = "Tenant ID is missing. Please refresh the page and sign in again.";
                StateHasChanged();
                return;
            }

            if (string.IsNullOrWhiteSpace(_configuration.JsonSample))
            {
                _errorMessage = "Please provide JSON sample data for schema creation.";
                StateHasChanged();
                return;
            }

            // Validate JSON format
            try
            {
                System.Text.Json.JsonDocument.Parse(_configuration.JsonSample);
            }
            catch (Exception jsonEx)
            {
                _errorMessage = $"Invalid JSON format: {jsonEx.Message}";
                StateHasChanged();
                return;
            }

            // Check authentication
            if (AuthenticationStateTask == null)
            {
                _errorMessage = "Authentication not available. Please refresh the page and try again.";
                StateHasChanged();
                return;
            }

            _isProcessing = true;
            StateHasChanged();

            var authState = await AuthenticationStateTask;
            if (!authState.User.Identity?.IsAuthenticated ?? true)
            {
                _errorMessage = "You must be authenticated to create app registrations.";
                _isProcessing = false;
                StateHasChanged();
                return;
            }

            var user = authState.User;

            // Step 1: Create App Registration
            if (_useAzureCli)
            {
                _appRegistrationResult = await AppRegistrationService.CreateAppRegistrationWithAzureCliAsync(_configuration.TenantId);
            }
            else
            {
                _appRegistrationResult = await AppRegistrationService.CreateAppRegistrationAsync(user, _configuration.TenantId);
            }

            if (!_appRegistrationResult.Success)
            {
                _errorMessage = _appRegistrationResult.ErrorMessage ?? "Failed to create app registration.";
                _isProcessing = false;
                StateHasChanged();
                return;
            }

            _currentStep = SetupStep.AppRegistrationCreated;
            StateHasChanged();

            // Check if admin consent is required (couldn't be granted automatically)
            if (_appRegistrationResult.AdminConsentRequired)
            {
                _currentStep = SetupStep.AdminConsentRequired;
                _isProcessing = false;
                StateHasChanged();
                return;
            }

            // Wait for app registration and client secret to propagate
            // This helps prevent AADSTS7000215 errors due to timing issues
            await Task.Delay(30000); // Wait 30 seconds for credential propagation

            // Step 2: Create Schema and Connection
            _forceShowUI = true; // Force UI to stay visible during processing
            _schemaResult = await SchemaService.CreateSchemaAndConnectionAsync(
                _configuration.TenantId,
                _appRegistrationResult.ApplicationId,
                _appRegistrationResult.ClientSecret,
                _configuration.JsonSample,
                _configuration.ConnectionName,
                _configuration.ConnectionDescription,
                _schemaMappingConfig);

            if (!_schemaResult.Success)
            {
                // Check if this is an admin consent issue
                if (_schemaResult.ErrorMessage?.Contains("admin consent") == true ||
                    _schemaResult.ErrorMessage?.Contains("Insufficient privileges") == true ||
                    _schemaResult.ErrorMessage?.Contains("Current authenticated context is not valid") == true)
                {
                    // Move to admin consent step instead of failing
                    _currentStep = SetupStep.AdminConsentRequired;
                    _isProcessing = false;
                    StateHasChanged();
                    return;
                }
                
                _errorMessage = _schemaResult.ErrorMessage ?? "Failed to create schema and connection.";
                _isProcessing = false;
                StateHasChanged();
                return;
            }

            _currentStep = SetupStep.Completed;
            _successMessage = "Setup completed successfully! Your external connection is ready to use.";
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task HandleSimplifiedConfiguration()
    {
        try
        {
            _errorMessage = "";
            _successMessage = "";
            
            // Validate required fields
            if (string.IsNullOrWhiteSpace(_configuration.TenantId))
            {
                _errorMessage = "Tenant ID is missing. Please refresh the page and sign in again.";
                StateHasChanged();
                return;
            }

            if (string.IsNullOrWhiteSpace(_configuration.JsonSample))
            {
                _errorMessage = "Please provide JSON sample data for schema creation.";
                StateHasChanged();
                return;
            }

            // Validate JSON format
            try
            {
                System.Text.Json.JsonDocument.Parse(_configuration.JsonSample);
            }
            catch (Exception jsonEx)
            {
                _errorMessage = $"Invalid JSON format: {jsonEx.Message}";
                StateHasChanged();
                return;
            }

            // Check authentication
            if (AuthenticationStateTask == null)
            {
                _errorMessage = "Authentication not available. Please refresh the page and try again.";
                StateHasChanged();
                return;
            }

            _isProcessing = true;
            StateHasChanged();

            var authState = await AuthenticationStateTask;
            if (!authState.User.Identity?.IsAuthenticated ?? true)
            {
                _errorMessage = "You must be authenticated to create external connections.";
                _isProcessing = false;
                StateHasChanged();
                return;
            }

            var user = authState.User;

            // Skip app registration creation - use existing OAuth app's delegated permissions
            _forceShowUI = true;
            _schemaResult = await SchemaService.CreateSchemaAndConnectionWithDelegatedPermissionsAsync(
                user,
                _configuration.JsonSample,
                _configuration.ConnectionName,
                _configuration.ConnectionDescription);

            if (!_schemaResult.Success)
            {
                _errorMessage = _schemaResult.ErrorMessage ?? "Failed to create schema and connection.";
                _isProcessing = false;
                StateHasChanged();
                return;
            }

            _currentStep = SetupStep.Completed;
            _successMessage = $"Setup completed successfully! External connection '{_configuration.ConnectionName}' is ready to use.";
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
            StateHasChanged();
        }
    }

    private void LoadSampleJson()
    {
                _configuration.JsonSample = @"{
    ""id"": ""sample-product-001"",
    ""title"": ""Sample Product"",
    ""description"": ""This is a sample product for demonstration"",
    ""price"": 29.99,
    ""category"": ""Electronics"",
    ""sku"": ""PROD-001"",
    ""inStock"": true,
    ""tags"": [""sample"", ""demo"", ""product""],
    ""manufacturer"": {
        ""name"": ""Sample Corp"",
        ""country"": ""USA""
    },
    ""lastUpdated"": ""2024-01-15T10:30:00Z""
}";
        StateHasChanged();
    }

    private async Task CopyToClipboard(string text)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
            // You could show a toast notification here
        }
        catch
        {
            // Fallback for older browsers
            await JSRuntime.InvokeVoidAsync("prompt", "Copy this value:", text);
        }
    }

    private void TestButton()
    {
        _errorMessage = "Test button clicked! Component is working.";
        StateHasChanged();
    }

    private void StartOver()
    {
        _configuration = new TenantConfigurationModel();
        _appRegistrationResult = null;
        _schemaResult = null;
        _currentStep = SetupStep.Configuration;
        _errorMessage = string.Empty;
        _successMessage = string.Empty;
        _showSecret = false;
        StateHasChanged();
    }

    private async Task OpenAdminConsentUrl(string clientId, string tenantId)
    {
        try
        {
            // Save state before opening consent window to survive auth transitions
            await SaveStateBeforeConsent();
            
            var consentUrl = AppRegistrationService.GenerateAdminConsentUrl(clientId, tenantId);
            await JSRuntime.InvokeVoidAsync("window.open", consentUrl, "_blank");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to open admin consent URL: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task RetrySchemaCreation()
    {
        try
        {
            if (_appRegistrationResult == null)
            {
                _errorMessage = "No app registration found. Please create the app registration first.";
                StateHasChanged();
                return;
            }

            _isProcessing = true;
            _errorMessage = string.Empty;
            _currentStep = SetupStep.AppRegistrationCreated;
            StateHasChanged();

            // Check if we already have a successful schema creation but failed container deployment
            bool schemaExistsButContainerFailed = (_schemaResult != null && _schemaResult.Success && !string.IsNullOrEmpty(_schemaResult.ConnectionId)) ||
                                                 (!string.IsNullOrEmpty(_errorMessage) && _errorMessage.Contains("Schema created but ingestion service deployment failed"));

            if (schemaExistsButContainerFailed)
            {
                // Schema/connection already exists, only retry the ingestion service deployment
                LogActivity("Schema and connection already exist. Retrying ingestion service deployment only.", ActivityLogType.Info);
                await DeployIngestionService();
                return;
            }

            // Schema creation failed or doesn't exist, so retry the full schema creation
            LogActivity("Retrying schema and connection creation...", ActivityLogType.Info);
            _schemaResult = await SchemaService.CreateSchemaAndConnectionAsync(
                _configuration.TenantId,
                _appRegistrationResult.ApplicationId,
                _appRegistrationResult.ClientSecret,
                _configuration.JsonSample,
                _configuration.ConnectionName,
                _configuration.ConnectionDescription,
                _schemaMappingConfig);

            if (!_schemaResult.Success)
            {
                _errorMessage = _schemaResult.ErrorMessage ?? "Failed to create schema and connection.";
                _currentStep = SetupStep.Configuration;
                LogActivity($"Schema creation failed: {_schemaResult.ErrorMessage}", ActivityLogType.Error);
            }
            else
            {
                _currentStep = SetupStep.Completed;
                _successMessage = "Setup completed successfully! Your external connection is ready to use.";
                LogActivity("Schema and connection created successfully!", ActivityLogType.Success);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred during retry: {ex.Message}";
            _currentStep = SetupStep.Configuration;
            LogActivity($"Error during retry: {ex.Message}", ActivityLogType.Error);
        }
        finally
        {
            _isProcessing = false;
            StateHasChanged();
        }
    }

    private enum SetupStep
    {
        Configuration,
        SchemaMapping,
        AppRegistrationCreated,
        AdminConsentRequired,
        CreatingConnection,
        Completed
    }

    private async Task ContinueAfterConsent()
    {
        if (_appRegistrationResult == null)
        {
            _errorMessage = "App registration information is missing.";
            LogActivity("Failed: App registration information is missing", ActivityLogType.Error);
            return;
        }

        try
        {
            _isProcessing = true;
            _currentRetryCount = 0;
            _currentStep = SetupStep.CreatingConnection; // set to creating step
            StartProcessTimer();
            LogActivity("Starting connection creation process", ActivityLogType.Info);
            StateHasChanged();

            const int maxRetries = 5;
            _maxRetries = maxRetries;
            Exception? lastException = null;

            for (int attempt = 1; attempt <= maxRetries; attempt++)
            {
                _currentRetryCount = attempt;
                _statusMessage = $"Creating connection... (Attempt {attempt} of {maxRetries})";
                LogActivity($"Attempt {attempt} of {maxRetries}: Creating external connection", ActivityLogType.Info);
                StateHasChanged();

                try
                {
                    _schemaResult = await SchemaService.CreateSchemaAndConnectionAsync(
                        _configuration.TenantId,
                        _appRegistrationResult.ApplicationId,
                        _appRegistrationResult.ClientSecret,
                        _configuration.JsonSample,
                        _configuration.ConnectionName,
                        _configuration.ConnectionDescription,
                        _schemaMappingConfig);

                    if (_schemaResult.Success)
                    {
                        _currentStep = SetupStep.Completed;
                        _successMessage = "Setup completed successfully! Your external connection is ready to use.";
                        _statusMessage = string.Empty;
                        LogActivity("Connection created successfully!", ActivityLogType.Success);
                        StopProcessTimer();
                        return;
                    }
                    else
                    {
                        lastException = new Exception(_schemaResult.ErrorMessage ?? "Unknown error");
                        LogActivity($"Attempt {attempt} failed: {_schemaResult.ErrorMessage}", ActivityLogType.Warning);
                    }
                }
                catch (Exception attemptEx)
                {
                    lastException = attemptEx;
                    LogActivity($"Attempt {attempt} threw exception: {attemptEx.Message}", ActivityLogType.Warning);
                }

                if (attempt < maxRetries)
                {
                    var delaySeconds = Math.Pow(2, attempt); // 2,4,8,16 seconds
                    _statusMessage = $"Attempt {attempt} failed. Retrying in {delaySeconds} seconds...";
                    LogActivity($"Waiting {delaySeconds} seconds before retry", ActivityLogType.Info);
                    StateHasChanged();
                    await Task.Delay(TimeSpan.FromSeconds(delaySeconds));
                }
                else
                {
                    _errorMessage = _schemaResult?.ErrorMessage ?? lastException?.Message ?? "Failed to create schema and connection after admin consent.";
                    LogActivity($"Final attempt failed: {_errorMessage}", ActivityLogType.Error);
                    break;
                }
            }

            if (_currentStep != SetupStep.Completed && lastException != null)
            {
                _errorMessage = $"Failed after {maxRetries} attempts. Last error: {lastException.Message}";
                LogActivity($"All {maxRetries} attempts failed. Process stopped.", ActivityLogType.Error);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An unexpected error occurred after admin consent: {ex.Message}";
            LogActivity($"Unexpected error: {ex.Message}", ActivityLogType.Error);
        }
        finally
        {
            _isProcessing = false;
            _statusMessage = string.Empty;
            StopProcessTimer();
            StateHasChanged();
        }
    }

    private async Task GrantAdminConsent(string clientId, string tenantId)
    {
        try
        {
            // Save state before opening consent window to survive auth transitions
            await SaveStateBeforeConsent();
            
            var consentUrl = AppRegistrationService.GenerateAdminConsentUrl(clientId, tenantId);
            await JSRuntime.InvokeVoidAsync("window.open", consentUrl, "_blank");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error opening admin consent URL: {ex.Message}";
            StateHasChanged();
        }
    }

    private string GetProgressWidth()
    {
        return _currentStep switch
        {
            SetupStep.Configuration => "16%",
            SetupStep.SchemaMapping => "33%",
            SetupStep.AppRegistrationCreated => "50%",
            SetupStep.AdminConsentRequired => "66%",
            SetupStep.CreatingConnection => "83%",
            SetupStep.Completed => "100%",
            _ => "16%"
        };
    }

    private int GetProgressValue()
    {
        return _currentStep switch
        {
            SetupStep.Configuration => 16,
            SetupStep.SchemaMapping => 33,
            SetupStep.AppRegistrationCreated => 50,
            SetupStep.AdminConsentRequired => 66,
            SetupStep.CreatingConnection => 83,
            SetupStep.Completed => 100,
            _ => 16
        };
    }

    // Activity Log and Timer Methods
    private void LogActivity(string message, ActivityLogType type = ActivityLogType.Info)
    {
        _activityLog.Add(new ActivityLogEntry
        {
            Timestamp = DateTime.Now,
            Message = message,
            Type = type
        });

        // Keep only the last 50 entries to avoid memory issues
        if (_activityLog.Count > 50)
        {
            _activityLog.RemoveRange(0, _activityLog.Count - 50);
        }

        InvokeAsync(StateHasChanged);
    }

    private void StartProcessTimer()
    {
        _processStartTime = DateTime.Now;
        _uiUpdateTimer?.Dispose();
        
        _uiUpdateTimer = new Timer(async _ =>
        {
            var elapsed = DateTime.Now - _processStartTime;
            _elapsedTime = elapsed.ToString(@"mm\:ss");
            await InvokeAsync(StateHasChanged);
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));

        LogActivity("Process timer started", ActivityLogType.Info);
    }

    private void StopProcessTimer()
    {
        _uiUpdateTimer?.Dispose();
        _uiUpdateTimer = null;
        LogActivity("Process timer stopped", ActivityLogType.Info);
    }

    private void ProceedToSchemaMapping()
    {
        try
        {
            _errorMessage = string.Empty;
            
            // Validate required fields
            if (string.IsNullOrWhiteSpace(_configuration.TenantId))
            {
                _errorMessage = "Tenant ID is required";
                return;
            }

            if (string.IsNullOrWhiteSpace(_configuration.JsonSample))
            {
                _errorMessage = "JSON sample is required";
                return;
            }

            // Validate JSON format
            try
            {
                System.Text.Json.JsonDocument.Parse(_configuration.JsonSample);
            }
            catch (Exception jsonEx)
            {
                _errorMessage = $"Invalid JSON format: {jsonEx.Message}";
                return;
            }

            _isProcessing = true;
            StateHasChanged();

            // Parse JSON and create schema mapping configuration
            _schemaMappingConfig = JsonFieldParserService.ParseJsonToSchema(
                _configuration.JsonSample,
                _configuration.ConnectionName,
                _configuration.ConnectionDescription);

            // Copy AllowedGroupIds from tenant configuration
            _schemaMappingConfig.AllowedGroupIds = _configuration.AllowedGroupIds ?? new List<string>();

            // Auto-assign semantic labels
            SemanticLabelMappingService.AssignSemanticLabels(_schemaMappingConfig.Fields);

            _currentStep = SetupStep.SchemaMapping;
            _successMessage = "JSON parsed successfully! Configure your schema fields and semantic labels below.";
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error parsing JSON: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task HandleSchemaMappingSubmit(SchemaMappingConfiguration mappingConfig)
    {
        try
        {
            _errorMessage = string.Empty;
            _successMessage = string.Empty;
            _isProcessing = true;
            _forceShowUI = true;
            StateHasChanged();

            // Check authentication
            if (AuthenticationStateTask == null)
            {
                _errorMessage = "Authentication is required. Please sign in.";
                return;
            }

            var authState = await AuthenticationStateTask;
            if (!authState.User.Identity?.IsAuthenticated ?? true)
            {
                _errorMessage = "Please sign in to continue.";
                return;
            }

            var user = authState.User;

            // Step 1: Create App Registration (if not using Azure CLI)
            if (_useAzureCli)
            {
                _successMessage = "Using Azure CLI authentication. Creating schema and connection...";
                StateHasChanged();
                await Task.Delay(1000);

                // Create schema and connection using mapping config with Azure CLI
                _schemaResult = await SchemaService.CreateSchemaAndConnectionFromMappingWithAzureCliAsync(
                    mappingConfig,
                    progress: new Progress<string>(message => 
                    {
                        _statusMessage = message;
                        InvokeAsync(StateHasChanged);
                    }));
            }
            else
            {
                // Create app registration first
                _appRegistrationResult = await AppRegistrationService.CreateAppRegistrationAsync(user, _configuration.TenantId);

                if (!_appRegistrationResult.Success)
                {
                    _errorMessage = _appRegistrationResult.ErrorMessage ?? "Failed to create app registration.";
                    return;
                }

                _currentStep = SetupStep.AppRegistrationCreated;
                StateHasChanged();

                // Check if admin consent is required (couldn't be granted automatically)
                if (_appRegistrationResult.AdminConsentRequired)
                {
                    _currentStep = SetupStep.AdminConsentRequired;
                    _isProcessing = false;
                    StateHasChanged();
                    return;
                }

                // Wait for app registration and client secret to propagate
                await Task.Delay(30000);

                // Create schema and connection using mapping config
                _schemaResult = await SchemaService.CreateSchemaAndConnectionFromMappingAsync(
                    user,
                    mappingConfig,
                    progress: new Progress<string>(message => 
                    {
                        _statusMessage = message;
                        InvokeAsync(StateHasChanged);
                    }));
            }

            if (!_schemaResult.Success)
            {
                _errorMessage = _schemaResult.ErrorMessage ?? "Failed to create schema and connection.";
                _isProcessing = false;
                // Keep _forceShowUI = true so error is visible
                StateHasChanged();
                return;
            }

            _currentStep = SetupStep.Completed;
            _successMessage = $"‚úÖ External connection '{mappingConfig.ConnectionName}' created successfully with custom schema mapping!";
            _forceShowUI = false; // Success - can hide UI now
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
            _isProcessing = false;
            // Keep _forceShowUI = true so error is visible
            StateHasChanged();
        }
        finally
        {
            _isProcessing = false;
            // Don't set _forceShowUI = false here - let success/error handling decide
            StateHasChanged();
        }
    }

    private void BackToConfiguration()
    {
        _currentStep = SetupStep.Configuration;
        _schemaMappingConfig = null;
        _errorMessage = string.Empty;
        _successMessage = string.Empty;
        StateHasChanged();
    }

    private async Task DeployIngestionService()
    {
        if (_appRegistrationResult == null || _schemaResult == null)
        {
            _errorMessage = "Missing required data for container deployment";
            StateHasChanged();
            return;
        }

        try
        {
            _isDeployingContainer = true;
            _errorMessage = string.Empty;
            StateHasChanged();

            // Get the current user's tenant ID instead of using app registration tenant ID
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var currentTenantId = user.FindFirst("tid")?.Value ?? user.FindFirst("http://schemas.microsoft.com/identity/claims/tenantid")?.Value;

            if (string.IsNullOrEmpty(currentTenantId))
            {
                _errorMessage = "Unable to determine current tenant ID from user authentication";
                StateHasChanged();
                return;
            }

            // Set status message directly
            _statusMessage = "üîç Parsing JSON structure and creating field mappings...";
            StateHasChanged();

            // Create schema mapping configuration for the existing connection
            var mappingConfig = JsonFieldParserService.ParseJsonToSchema(_configuration.JsonSample);
            SemanticLabelMappingService.AssignSemanticLabels(mappingConfig.Fields);

            _statusMessage = "üê≥ Building and deploying ingestion service container...";
            StateHasChanged();
            
            // Deploy container for the EXISTING connection (don't create a new connection)
            var deploymentResult = await ContainerService.DeployIngestionServiceAsync(
                _schemaResult.ConnectionId!,  // Use EXISTING connection ID
                currentTenantId,  // Use current user's tenant ID
                _appRegistrationResult.ApplicationId,
                _appRegistrationResult.ClientSecret,
                mappingConfig);

            _containerDeploymentResult = new CompleteDeploymentResult
            {
                Success = deploymentResult.Success,
                ErrorMessage = deploymentResult.ErrorMessage,
                SchemaResult = _schemaResult, // Use existing schema result
                DeploymentResult = deploymentResult,
                MappingConfiguration = mappingConfig
            };

            if (deploymentResult.Success)
            {
                _successMessage = "üéâ Ingestion service deployed successfully! Your external connection is now ready to receive data.";
            }
            else
            {
                _errorMessage = $"Container deployment failed: {deploymentResult.ErrorMessage}";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error during deployment: {ex.Message}";
        }
        finally
        {
            _isDeployingContainer = false;
            _statusMessage = string.Empty;
            StateHasChanged();
        }
    }

    // State persistence methods to handle auth transitions during consent
    private async Task SaveStateBeforeConsent()
    {
        try
        {
            if (_appRegistrationResult == null) return;
            
            var state = new
            {
                AppId = _appRegistrationResult.ApplicationId,
                TenantId = _appRegistrationResult.TenantId,
                ClientSecret = _appRegistrationResult.ClientSecret,
                ConnectionName = _configuration.ConnectionName,
                ConnectionDescription = _configuration.ConnectionDescription,
                JsonSample = _configuration.JsonSample,
                ConfigTenantId = _configuration.TenantId,
                AllowedGroupIds = _configuration.AllowedGroupIds,
                CurrentStep = _currentStep.ToString(),
                Timestamp = DateTime.UtcNow.Ticks
            };
            
            var json = System.Text.Json.JsonSerializer.Serialize(state);
            await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "copilotSetupState", json);
        }
        catch (Exception ex)
        {
            // Log but don't fail - state save is best effort
            Console.WriteLine($"Failed to save state: {ex.Message}");
        }
    }
    
    private async Task<bool> TryRestoreStateAfterConsent()
    {
        try
        {
            var json = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "copilotSetupState");
            if (string.IsNullOrEmpty(json)) return false;
            
            var state = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(json);
            
            // Check if state is recent (within last 10 minutes)
            if (state.TryGetProperty("Timestamp", out var timestamp))
            {
                var stateTime = new DateTime(timestamp.GetInt64());
                if (DateTime.UtcNow - stateTime > TimeSpan.FromMinutes(10))
                {
                    // State is too old, clear it
                    await JSRuntime.InvokeVoidAsync("sessionStorage.removeItem", "copilotSetupState");
                    return false;
                }
            }
            
            // Restore app registration result
            _appRegistrationResult = new AppRegistrationResult
            {
                Success = true,
                ApplicationId = state.GetProperty("AppId").GetString() ?? "",
                TenantId = state.GetProperty("TenantId").GetString() ?? "",
                ClientSecret = state.GetProperty("ClientSecret").GetString() ?? "",
                AdminConsentRequired = true // We're restoring after consent was needed
            };
            
            // Restore configuration
            _configuration.ConnectionName = state.GetProperty("ConnectionName").GetString() ?? "";
            _configuration.ConnectionDescription = state.GetProperty("ConnectionDescription").GetString() ?? "";
            _configuration.JsonSample = state.GetProperty("JsonSample").GetString() ?? "";
            if (state.TryGetProperty("ConfigTenantId", out var configTenantId))
            {
                _configuration.TenantId = configTenantId.GetString() ?? "";
            }
            
            // Restore ACL group selections
            if (state.TryGetProperty("AllowedGroupIds", out var groupIds))
            {
                _configuration.AllowedGroupIds = new List<string>();
                foreach (var groupId in groupIds.EnumerateArray())
                {
                    var id = groupId.GetString();
                    if (!string.IsNullOrEmpty(id))
                    {
                        _configuration.AllowedGroupIds.Add(id);
                    }
                }
            }
            
            // Restore step - set to AdminConsentRequired so user sees the "Continue Setup" button
            if (state.TryGetProperty("CurrentStep", out var stepJson) && 
                Enum.TryParse<SetupStep>(stepJson.GetString(), out var step))
            {
                _currentStep = step;
            }
            
            // Clear the saved state
            await JSRuntime.InvokeVoidAsync("sessionStorage.removeItem", "copilotSetupState");
            
            return true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to restore state: {ex.Message}");
            return false;
        }
    }

    private async Task LoadEntraIdGroups()
    {
        _isLoadingGroups = true;
        _errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            if (AuthenticationStateTask == null) return;
            
            var authState = await AuthenticationStateTask;
            if (!authState.User.Identity?.IsAuthenticated ?? true)
            {
                _errorMessage = "You must be signed in to load Entra ID groups.";
                return;
            }

            var groups = await GraphService.GetEntraIdGroupsAsync(authState.User);
            _availableGroups = groups.Select(g => new EntraIdGroupInfo
            {
                Id = g.Id ?? string.Empty,
                DisplayName = g.DisplayName ?? string.Empty,
                Description = g.Description,
                Mail = g.Mail
            }).ToList();

            LogActivity($"Loaded {_availableGroups.Count} Entra ID groups for ACL configuration", ActivityLogType.Success);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load Entra ID groups: {ex.Message}";
            LogActivity($"Error loading groups: {ex.Message}", ActivityLogType.Error);
        }
        finally
        {
            _isLoadingGroups = false;
            StateHasChanged();
        }
    }

    private void ToggleGroupSelection(string groupId, bool isSelected)
    {
        if (isSelected)
        {
            if (!_configuration.AllowedGroupIds.Contains(groupId))
            {
                _configuration.AllowedGroupIds.Add(groupId);
            }
        }
        else
        {
            _configuration.AllowedGroupIds.Remove(groupId);
        }
        StateHasChanged();
    }

    public void Dispose()
    {
        _uiUpdateTimer?.Dispose();
    }
}
